# –ú–æ–¥—É–ª—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–ø–≥—Ä–µ–π–¥–∞ (Upgrade Module)

–ú–æ–¥—É–ª—å –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≤—ã—à–µ–Ω–∏—è –∫–ª–∞—Å—Å–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è (–∞–ø–≥—Ä–µ–π–¥–∞) –¥–æ –ë–∏–∑–Ω–µ—Å–∞ –∑–∞ –º–∏–ª–∏ –ê—ç—Ä–æ—Ñ–ª–æ—Ç–∞ –¥–ª—è —É–∂–µ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤.

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

1.  **–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö**:
    *   –ö–æ–¥ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (PNR): 6 —Å–∏–º–≤–æ–ª–æ–≤ (–ª–∞—Ç–∏–Ω–∏—Ü–∞ + —Ü–∏—Ñ—Ä—ã).
    *   –§–∞–º–∏–ª–∏—è –ø–∞—Å—Å–∞–∂–∏—Ä–∞: —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞.
2.  **–ü–∞—Ä—Å–∏–Ω–≥ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è**:
    *   –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –Ω–∞ —Å–∞–π—Ç–µ –ê—ç—Ä–æ—Ñ–ª–æ—Ç–∞.
    *   –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–∞—Ä—à—Ä—É—Ç–µ (—Å–µ–≥–º–µ–Ω—Ç—ã, –ø–µ—Ä–µ—Å–∞–¥–∫–∏).
    *   –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–¥–∞ —Ç–∞—Ä–∏—Ñ–∞ (Fare Basis) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª–µ—Ç–Ω–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞.
    *   –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π —Ä–µ–π—Å–∞ (–¥–∞—Ç–∞, –Ω–æ–º–µ—Ä —Ä–µ–π—Å–∞, –∞—ç—Ä–æ–ø–æ—Ä—Ç—ã –≤—ã–ª–µ—Ç–∞/–ø—Ä–∏–ª–µ—Ç–∞).
3.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞—Ä–∏—Ñ–∞ (Eligibility)**:
    *   **–ü—Ä–∞–≤–∏–ª–æ 1**: –ö–æ–¥ —Ç–∞—Ä–∏—Ñ–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–¥–Ω—É –∏–∑ –ø–æ–¥—Å—Ç—Ä–æ–∫: `FM`, `FO`, `PM`, `XM` (–≥—Ä—É–ø–ø–∞ –ú–∞–∫—Å–∏–º—É–º).
    *   **–ü—Ä–∞–≤–∏–ª–æ 2 (–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥)**: –î–ª—è —Ä–µ–π—Å–æ–≤ –≤/–∏–∑ –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥–∞ (KGD) —Ç–∞–∫–∂–µ –ø–æ–¥—Ö–æ–¥—è—Ç —Å–ø–µ—Ü—Ç–∞—Ä–∏—Ñ—ã `BPXOWRF` –∏ `BPXRTRF`.
4.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –º–µ—Å—Ç (Availability)**:
    *   –ï—Å–ª–∏ —Ç–∞—Ä–∏—Ñ –ø–æ–¥—Ö–æ–¥–∏—Ç, –º–æ–¥—É–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–∏—Å–∫ –±–∏–ª–µ—Ç–æ–≤ –∑–∞ –º–∏–ª–∏ –Ω–∞ —ç—Ç–æ—Ç –∂–µ —Ä–µ–π—Å.
    *   –ï—Å–ª–∏ –º–µ—Å—Ç–∞ –≤ –ë–∏–∑–Ω–µ—Å-–∫–ª–∞—Å—Å–µ –∑–∞ –º–∏–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã, —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∞–ø–≥—Ä–µ–π–¥–∞.
5.  **–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏**:
    *   –°—Ç–æ–∏–º–æ—Å—Ç—å –∞–ø–≥—Ä–µ–π–¥–∞ = (–°—Ç–æ–∏–º–æ—Å—Ç—å –º–∏–ª—å–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞ –≤ –æ–¥–Ω—É —Å—Ç–æ—Ä–æ–Ω—É) / 2.
    *   –°—Ç–æ–∏–º–æ—Å—Ç—å –≤ —Ä—É–±–ª—è—Ö = –°—Ç–æ–∏–º–æ—Å—Ç—å –≤ –º–∏–ª—è—Ö * `MILE_RATE` (–∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞).

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞

### 1. `aeroflot_upgrade.py`
–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –º–æ–¥—É–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞.

*   **Class `AeroflotUpgradeParser`**:
    *   `check_upgrade(pnr_code, last_name)`: –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –±—Ä–∞—É–∑–µ—Ä, –≤–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ, –ø–∞—Ä—Å–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
    *   `_check_fare_eligibility(fare_code, is_kaliningrad)`: –õ–æ–≥–∏–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–∞—Ä–∏—Ñ–∞.
    *   `_extract_flight_details(segment_text)`: –ü–∞—Ä—Å–∏–Ω–≥ —Å—ã—Ä–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞—Ç—ã, –Ω–æ–º–µ—Ä–∞ —Ä–µ–π—Å–∞ –∏ –∫–æ–¥–æ–≤ –∞—ç—Ä–æ–ø–æ—Ä—Ç–æ–≤.

### 2. `bot.py`
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Telegram-–±–æ—Ç–∞.

*   **–ö–Ω–æ–ø–∫–∞**: `üíé –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–ø–≥—Ä–µ–π–¥` –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é.
*   **FSM States**: `UpgradeStates.waiting_booking_code` -> `UpgradeStates.waiting_last_name`.
*   **–í–∞–ª–∏–¥–∞—Ü–∏—è**:
    *   –ö–æ–¥ –±—Ä–æ–Ω–∏: Regex `^[A-Z0-9]{6}$`.
    *   –§–∞–º–∏–ª–∏—è: Regex `^[A-Z\-\s]+$`.
*   **–õ–æ–≥–∏–∫–∞**:
    1.  –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    2.  –í—ã–∑—ã–≤–∞–µ—Ç `AeroflotUpgradeParser.check_upgrade`.
    3.  –ï—Å–ª–∏ —Ç–∞—Ä–∏—Ñ –ø–æ–¥—Ö–æ–¥–∏—Ç, –≤—ã–∑—ã–≤–∞–µ—Ç `AeroflotParser.get_tickets` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –º–µ—Å—Ç.
    4.  –§–æ—Ä–º–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –∫–∞–∂–¥–æ–º—É —Å–µ–≥–º–µ–Ω—Ç—É.

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
*   **–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**: –ï—Å–ª–∏ —Å–∞–π—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç "–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ", –±–æ—Ç —Å–æ–æ–±—â–∞–µ—Ç –æ–± —ç—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å –ø—Ä–æ—Å—å–±–æ–π –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
*   **–¢–∞–π–º–∞—É—Ç—ã**: –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ "—É–º–Ω–æ–µ" –æ–∂–∏–¥–∞–Ω–∏–µ (race condition) —É—Å–ø–µ—Ö–∞ –∏–ª–∏ –æ—à–∏–±–∫–∏.

## –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

1.  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "üíé –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–ø–≥—Ä–µ–π–¥".
2.  –í–≤–æ–¥–∏—Ç –∫–æ–¥ –±—Ä–æ–Ω–∏: `6T4KSV`.
3.  –í–≤–æ–¥–∏—Ç —Ñ–∞–º–∏–ª–∏—é: `GORSKIY`.
4.  –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç:
    > üé´ **–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:** 6T4KSV
    > üë§ **–§–∞–º–∏–ª–∏—è:** GORSKIY
    >
    > **–°–µ–≥–º–µ–Ω—Ç 1:** SVO ‚û°Ô∏è NOZ (19.02.2026), SU1459
    > üìä –¢–∞—Ä–∏—Ñ: –≠–∫–æ–Ω–æ–º (TFMR)
    > ‚úÖ –¢–∞—Ä–∏—Ñ –ø–æ–¥—Ö–æ–¥–∏—Ç.
    > üéü **–ú–µ—Å—Ç–∞ –¥–ª—è –∞–ø–≥—Ä–µ–π–¥–∞ –ï–°–¢–¨!**
    > üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: 15 000 –º–∏–ª—å = **15 000 —Ä—É–±**
    >
    > üéâ **–í–µ—Å—å –º–∞—Ä—à—Ä—É—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∞–ø–≥—Ä–µ–π–¥–∞!**

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
–¢–µ –∂–µ, —á—Ç–æ –∏ —É –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ (Playwright, Aiogram), –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.


